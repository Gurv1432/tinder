<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Match Prototype</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS STYLES (Modern UI) --- */
        :root {
            --primary-color: #ff4b6a; /* Tinder-ish Pink/Red */
            --secondary-color: #6c757d;
            --bg-light: #f8f9fa;
            --text-dark: #212529;
            --chat-sent: #ff4b6a;
            --chat-received: #e9ecef;
            --app-height: 100vh;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #e9ecef; height: var(--app-height); display: flex; justify-content: center; align-items: center; overflow: hidden; }

        /* Main App Container */
        #app-container {
            width: 100%; max-width: 414px; /* Mobile size */
            height: 100%; background: white; position: relative;
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Top Header --- */
        .app-header {
            height: 60px; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #eee; font-weight: 600; color: var(--text-dark);
            position: relative; z-index: 10; background: white;
        }
        .location-indicator { font-size: 0.9rem; color: var(--primary-color); display: flex; align-items: center; }
        .location-indicator i { margin-right: 5px; }

        /* --- Main Content Area --- */
        .app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 60px; /* Space for bottom nav */ }

        /* Screens/Views */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .view-section.active { display: flex; }
        .no-padding { padding: 0; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around;
            align-items: center; position: absolute; bottom: 0; width: 100%; background: white; z-index: 10;
        }
        .nav-item { color: var(--secondary-color); font-size: 1.5rem; position: relative; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%; display: none;}

        /* --- UI Elements --- */
        .btn { padding: 12px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-outline { border: 2px solid var(--secondary-color); color: var(--secondary-color); background: transparent;}
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        .form-label { font-size: 0.9rem; color: var(--secondary-color); margin-bottom: 5px; display: block; }

        /* --- Suggestion Card (Tinder Style) --- */
        .card-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; position: relative; }
        .profile-card {
            width: 100%; height: 100%; max-height: 500px; border-radius: 20px; overflow: hidden;
            position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.1); background: #ddd;
        }
        .card-image { width: 100%; height: 100%; object-fit: cover; }
        .card-details {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 20px;
        }
        .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; position: absolute; bottom: 30px; width: 100%; }
        .action-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-deny { background: white; color: red; }
        .btn-like { background: white; color: var(--primary-color); }

        /* --- Lists (Requests & Chat) --- */
        .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #ddd;}
        .list-info { flex: 1; }
        .list-name { font-weight: 600; }
        .list-sub { font-size: 0.8rem; color: var(--secondary-color); }
        .request-actions { display: flex; gap: 10px; }
        .req-btn { padding: 5px 15px; border-radius: 15px; border: none; cursor: pointer; font-size: 0.8rem;}
        .req-accept { background: var(--primary-color); color: white; }

        /* --- Chat Interface --- */
        #chat-window-view { z-index: 20; padding-bottom: 0; } /* Overlap bottom nav */
        .chat-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .back-btn { font-size: 1.2rem; margin-right: 15px; cursor: pointer; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: var(--bg-light); }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; position: relative; word-wrap: break-word;}
        .msg-sent { align-self: flex-end; background: var(--chat-sent); color: white; border-bottom-right-radius: 5px; }
        .msg-received { align-self: flex-start; background: var(--chat-received); color: var(--text-dark); border-bottom-left-radius: 5px; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; background: white; }
        .chat-input { flex: 1; border: none; padding: 10px; outline: none; max-height: 100px; overflow-y: auto; }
        .chat-actions i { font-size: 1.3rem; color: var(--secondary-color); margin-left: 15px; cursor: pointer; }
        .chat-image-preview { max-width: 200px; border-radius: 10px; margin-bottom: 5px; display: block; }

        /* --- Developer Mode & Profile --- */
        .dev-panel { background: #333; color: white; padding: 15px; margin-top: 20px; border-radius: 10px; display: none;}
        .dev-panel.active { display: block; }
        .profile-pic-upload { width: 100px; height: 100px; background: #ddd; border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden;}
        .profile-pic-upload img { width: 100%; height: 100%; object-fit: cover; }
        .upload-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; text-align: center; font-size: 0.8rem; padding: 5px; cursor: pointer;}

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-container">
    <div class="app-header">
        <div id="header-title">Discover</div>
        <div class="location-indicator hidden" id="location-header">
            <i class="fas fa-map-marker-alt"></i> <span id="user-location-span">Set Location</span>
        </div>
    </div>

    <div class="app-content">

        <div id="signup-view" class="view-section active" style="justify-content: center;">
            <h1 style="text-align: center; margin-bottom: 30px; color: var(--primary-color);">MatchMe</h1>
            <div class="form-group">
                <input type="text" id="signup-username" class="form-input" placeholder="Choose a Username">
            </div>
            <button class="btn btn-primary" onclick="handleSignup()">Get Started</button>
        </div>

        <div id="profile-setup-view" class="view-section">
            <h2>Complete Profile</h2>
            <p style="margin-bottom: 20px; color: var(--secondary-color);">Set up your profile to be seen.</p>
            
            <div class="profile-pic-upload" onclick="document.getElementById('profile-img-input').click()">
                <img id="profile-preview" src="https://via.placeholder.com/100" alt="Profile">
                <div class="upload-overlay">Upload</div>
                <input type="file" id="profile-img-input" hidden accept="image/*" onchange="previewImage(event)">
            </div>

            <div class="form-group">
                <label class="form-label">Full Name (Mandatory)</label>
                <input type="text" id="setup-name" class="form-input" placeholder="Eg. Rahul Sharma">
            </div>
             <div class="form-group">
                <label class="form-label">Location City (Mandatory for matching)</label>
                <input type="text" id="setup-location" class="form-input" placeholder="Eg. Delhi, Mumbai">
            </div>
            <div class="form-group">
                <label class="form-label">Email (Optional)</label>
                <input type="email" id="setup-email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Phone (Optional)</label>
                <input type="tel" id="setup-phone" class="form-input" placeholder="+91...">
            </div>
            <button class="btn btn-primary" onclick="completeProfile()">Save & Continue</button>
        </div>

        <div id="home-view" class="view-section no-padding">
            <div class="card-container" id="card-area">
                <div style="text-align: center; color: var(--secondary-color);">Searching for people nearby...</div>
            </div>
        </div>

        <div id="requests-view" class="view-section no-padding">
            <div id="requests-list">
                <p style="padding: 20px; text-align: center; color: var(--secondary-color);">No pending requests.</p>
            </div>
        </div>

        <div id="chat-list-view" class="view-section no-padding">
            <div id="matches-list">
               <p style="padding: 20px; text-align: center; color: var(--secondary-color);">No matches yet. Start swiping!</p>
            </div>
        </div>

        <div id="profile-view" class="view-section">
             <div class="profile-pic-upload">
                <img id="my-profile-pic" src="" alt="My Profile">
            </div>
            <h2 style="text-align: center;" id="my-profile-name">User</h2>
            <p style="text-align: center; color: var(--secondary-color);" id="my-profile-loc">Location</p>
            
            <div style="margin-top: 30px;">
                 <button class="btn btn-outline" style="margin-bottom: 10px;">Edit Profile</button>
                 <button class="btn btn-outline" style="border-color: #333; color: #333;" onclick="toggleDevMode()">Developer Tools <i class="fas fa-code"></i></button>
            </div>

            <div id="dev-panel-area" class="dev-panel">
                <h3>Developer Mode</h3>
                <p style="font-size: 0.8rem; margin-bottom: 10px;">Generate fake traffic or impersonate users.</p>
                <button class="btn btn-primary" style="margin-bottom: 10px; background: #555;" onclick="generateFakeUsers(5)">Generate 5 Fake Users in My Location</button>
                
                <div class="form-group">
                    <label class="form-label" style="color: #ccc;">Impersonate User (to see their chats)</label>
                    <select id="dev-user-select" class="form-input" onchange="devSwitchUser()">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <button class="btn btn-outline" style="color: white; border-color: white;" onclick="resetApp()">Reset App Data</button>
            </div>
        </div>
        
    </div> <div id="chat-window-view" class="view-section">
        <div class="chat-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeChatWindow()"></i>
            <img id="chat-with-avatar" class="list-avatar" style="width: 40px; height: 40px; margin-right: 10px;" src="">
            <div style="font-weight: 600;" id="chat-with-name">Name</div>
        </div>
        <div class="chat-messages" id="chat-messages-area">
            </div>
        <div class="chat-input-area">
             <input type="file" id="chat-image-input" hidden accept="image/*" onchange="handleChatImageSelect(event)">
            <textarea class="chat-input" id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <div class="chat-actions">
                <i class="far fa-image" onclick="document.getElementById('chat-image-input').click()"></i>
                <i class="fas fa-paper-plane" style="color: var(--primary-color);" onclick="sendMessage()"></i>
            </div>
        </div>
    </div>


    <div class="bottom-nav" id="main-nav">
        <div class="nav-item active" onclick="navigateTo('home')"><i class="fas fa-fire"></i></div>
        <div class="nav-item" onclick="navigateTo('requests')">
            <i class="fas fa-heart"></i>
            <span class="badge" id="request-badge">0</span>
        </div>
        <div class="nav-item" onclick="navigateTo('chat-list')"><i class="fas fa-comment-alt"></i></div>
        <div class="nav-item" onclick="navigateTo('profile')"><i class="fas fa-user"></i></div>
    </div>

</div>

<script>
    /* --- JAVASCRIPT LOGIC (The Brain) --- */

    // --- DATA STRUCTURES (Simulating a Database) ---
    let currentUser = null; // The currently logged-in user object
    let usersDb = []; // Array holding all user profiles (real + fake)
    let matchesDb = []; // Array holding match status: { info: {from: id, to: id, status: 'pending'|'matched'|'denied'}, chats: [] }
    let currentChatPartnerId = null; // ID of the person currently being chatted with
    let devModeActive = false;
    let realUserId = null; // To remember the real user when dev switches context

    // --- INITIALIZATION ---
    window.onload = function() {
        loadFromStorage();
        checkLoginStatus();
        // Fake initial data if empty for demo
        if(usersDb.length === 0) {
             usersDb = [
                { id: 'user_1', name: 'Priya Sharma', location: 'Delhi', pic: 'https://randomuser.me/api/portraits/women/65.jpg', isFake: true },
                { id: 'user_2', name: 'Rahul Verma', location: 'Mumbai', pic: 'https://randomuser.me/api/portraits/men/32.jpg', isFake: true },
                { id: 'user_3', name: 'Anjali Desai', location: 'Delhi', pic: 'https://randomuser.me/api/portraits/women/22.jpg', isFake: true },
             ];
             saveToStorage();
        }
    };

    // --- NAVIGATION & VIEW HANDLING ---
    function navigateTo(viewName) {
        // Update Bottom Nav UI
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if(viewName === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        if(viewName === 'requests') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        if(viewName === 'chat-list') document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        if(viewName === 'profile') document.querySelector('.nav-item:nth-child(4)').classList.add('active');

        // Header Title Update
        const titles = { 'home': 'Discover', 'requests': 'Requests', 'chat-list': 'Messages', 'profile': 'My Profile' };
        document.getElementById('header-title').innerText = titles[viewName] || '';

        // Show/Hide Views
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        document.getElementById(viewName + '-view').classList.add('active');

        // Refresh data based on view
        if(viewName === 'home') loadSuggestions();
        if(viewName === 'requests') loadRequests();
        if(viewName === 'chat-list') loadChatList();
        if(viewName === 'profile') loadMyProfileData();
    }

    function checkLoginStatus() {
        if (!currentUser) {
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('location-header').classList.add('hidden');
            document.getElementById('signup-view').classList.add('active');
        } else if (!currentUser.isProfileComplete) {
             document.getElementById('main-nav').style.display = 'none';
             document.getElementById('location-header').classList.add('hidden');
             // Hide signup, show profile setup
             document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
             document.getElementById('profile-setup-view').classList.add('active');
        } else {
            // Logged in and profile complete
            realUserId = currentUser.id; // Store real ID
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('location-header').classList.remove('hidden');
            document.getElementById('user-location-span').innerText = currentUser.location;
            document.getElementById('signup-view').classList.remove('active');
            navigateTo('home');
        }
    }

    // --- SIGNUP & PROFILE FLOW ---
    function handleSignup() {
        const username = document.getElementById('signup-username').value;
        if (!username) return alert("Please enter a username");
        
        currentUser = {
            id: 'user_' + Date.now(),
            username: username,
            isProfileComplete: false
        };
        // Add to DB
        usersDb.push(currentUser);
        saveToStorage();
        checkLoginStatus();
    }

    let tempProfilePicBlob = 'https://via.placeholder.com/400x500?text=No+Image'; // Default

    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            tempProfilePicBlob = URL.createObjectURL(file);
            document.getElementById('profile-preview').src = tempProfilePicBlob;
        }
    }

    function completeProfile() {
        const name = document.getElementById('setup-name').value;
        const location = document.getElementById('setup-location').value;
         // Mandatory check (Name, Location, and Profile Pic is mandatory in UI by default placeholder)
        if(!name || !location) return alert("Name and Location are mandatory.");

        // Find current user in DB and update
        const userIdx = usersDb.findIndex(u => u.id === currentUser.id);
        if(userIdx !== -1) {
            usersDb[userIdx].name = name;
            usersDb[userIdx].location = location;
            usersDb[userIdx].email = document.getElementById('setup-email').value;
            usersDb[userIdx].phone = document.getElementById('setup-phone').value;
            usersDb[userIdx].pic = tempProfilePicBlob; // In a real app, this would be a server URL
            usersDb[userIdx].isProfileComplete = true;
            currentUser = usersDb[userIdx]; // Update local session
            saveToStorage();
            checkLoginStatus();
        }
    }


    // --- CORE LOGIC: SUGGESTIONS & MATCHING ---

    function loadSuggestions() {
        const cardArea = document.getElementById('card-area');
        cardArea.innerHTML = '<div style="text-align: center; color: var(--secondary-color);">Finding people near ' + currentUser.location + '...</div>';

        // 1. Filter users by same location
        // 2. Exclude self
        // 3. Exclude users already interacted with (liked/denied/matched) in matchesDb
        const interactedIds = matchesDb
            .filter(m => m.info.from === currentUser.id || m.info.to === currentUser.id)
            .map(m => m.info.from === currentUser.id ? m.info.to : m.info.from);

        const suggestions = usersDb.filter(user => {
            return user.id !== currentUser.id && 
                   user.location.toLowerCase() === currentUser.location.toLowerCase() &&
                   user.isProfileComplete &&
                   !interactedIds.includes(user.id);
        });

        if (suggestions.length === 0) {
             cardArea.innerHTML = '<div style="text-align: center; color: var(--secondary-color); padding: 20px;">No new folks around here right now.<br>Try Developer Mode to add fake users!</div>';
             return;
        }

        // Show the first suggestion (Simple stack approach)
        const person = suggestions[0];
        renderCard(person);
    }

    function renderCard(person) {
        const cardHtml = `
            <div class="profile-card">
                <img src="${person.pic}" class="card-image" alt="${person.name}">
                <div class="card-details">
                    <h2>${person.name}</h2>
                    <p><i class="fas fa-map-marker-alt"></i> ${person.location}</p>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-deny" onclick="handleAction('${person.id}', 'deny')"><i class="fas fa-times"></i></button>
                <button class="action-btn btn-like" onclick="handleAction('${person.id}', 'like')"><i class="fas fa-heart"></i></button>
            </div>
        `;
        document.getElementById('card-area').innerHTML = cardHtml;
    }

    function handleAction(targetUserId, action) {
        // Create match entry
        matchesDb.push({
            info: {
                from: currentUser.id,
                to: targetUserId,
                status: action === 'like' ? 'pending' : 'denied',
                timestamp: Date.now()
            },
            chats: []
        });
        saveToStorage();
        loadSuggestions(); // Load next
        updateBadges();

        // Simulate fake user accepting immediately if in dev mode to test chat
        if(action === 'like' && devModeActive) {
            const targetUser = usersDb.find(u => u.id === targetUserId);
            if(targetUser && targetUser.isFake) {
                 setTimeout(() => {
                     acceptRequest(currentUser.id, targetUserId); // Fake user accepts YOU
                     alert(`Dev Mode: Fake user ${targetUser.name} accepted your request!`);
                 }, 1500);
            }
        }
    }

    // --- REQUESTS & ACCEPTANCE ---
    function loadRequests() {
        const list = document.getElementById('requests-list');
        // Find likes sent TO current user that are PENDING
        const pendingRequests = matchesDb.filter(m => m.info.to === currentUser.id && m.info.status === 'pending');

        if(pendingRequests.length === 0) {
            list.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--secondary-color);">No pending requests.</p>';
            return;
        }

        let html = '';
        pendingRequests.forEach(req => {
            const sender = usersDb.find(u => u.id === req.info.from);
            if(sender) {
                html += `
                    <div class="list-item">
                        <img src="${sender.pic}" class="list-avatar">
                        <div class="list-info">
                            <div class="list-name">${sender.name}</div>
                            <div class="list-sub">Liked you</div>
                        </div>
                        <div class="request-actions">
                            <button class="req-btn" onclick="denyRequest('${req.info.from}')">Deny</button>
                            <button class="req-btn req-accept" onclick="acceptRequest('${req.info.from}')">Accept</button>
                        </div>
                    </div>
                `;
            }
        });
        list.innerHTML = html;
    }

    function acceptRequest(fromUserId, toUserIdOverride = null) {
        const toId = toUserIdOverride || currentUser.id;
        const matchIndex = matchesDb.findIndex(m => m.info.from === fromUserId && m.info.to === toId && m.info.status === 'pending');
        if(matchIndex !== -1) {
            matchesDb[matchIndex].info.status = 'matched'; // Connection established!
            saveToStorage();
            loadRequests();
            updateBadges();
            // Optionally auto-navigate to chats
            if(!toUserIdOverride) navigateTo('chat-list'); 
        }
    }

    function denyRequest(fromUserId) {
         const matchIndex = matchesDb.findIndex(m => m.info.from === fromUserId && m.info.to === currentUser.id && m.info.status === 'pending');
         if(matchIndex !== -1) {
            matchesDb[matchIndex].info.status = 'denied';
            saveToStorage();
            loadRequests();
            updateBadges();
         }
    }
    
    function updateBadges() {
         const pendingCount = matchesDb.filter(m => m.info.to === currentUser.id && m.info.status === 'pending').length;
         const badge = document.getElementById('request-badge');
         if(pendingCount > 0) {
             badge.innerText = pendingCount;
             badge.style.display = 'block';
         } else {
             badge.style.display = 'none';
         }
    }

    // --- CHAT LIST & CHATING ---
    function loadChatList() {
        const list = document.getElementById('matches-list');
        // Find all matches where status is 'matched' AND current user is involved
        const myMatches = matchesDb.filter(m => m.info.status === 'matched' && (m.info.from === currentUser.id || m.info.to === currentUser.id));

        if(myMatches.length === 0) {
             list.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--secondary-color);">No matches yet.</p>';
             return;
        }

        let html = '';
        myMatches.forEach(match => {
            // Determine who the "other" person is
            const otherUserId = match.info.from === currentUser.id ? match.info.to : match.info.from;
            const otherUser = usersDb.find(u => u.id === otherUserId);
            
            const lastMsg = match.chats.length > 0 ? match.chats[match.chats.length-1].text : 'Start chatting!';
            const isImage = lastMsg.includes('<img');

            if(otherUser) {
                html += `
                    <div class="list-item" onclick="openChatWindow('${otherUser.id}')">
                        <img src="${otherUser.pic}" class="list-avatar">
                        <div class="list-info">
                            <div class="list-name">${otherUser.name}</div>
                            <div class="list-sub">${isImage ? 'Sent an image' : lastMsg.substring(0, 25) + '...'}</div>
                        </div>
                    </div>
                `;
            }
        });
        list.innerHTML = html;
    }

    function openChatWindow(partnerId) {
        currentChatPartnerId = partnerId;
        const partner = usersDb.find(u => u.id === partnerId);
        
        document.getElementById('chat-with-name').innerText = partner.name;
        document.getElementById('chat-with-avatar').src = partner.pic;
        document.getElementById('chat-window-view').classList.add('active');
        document.getElementById('main-nav').style.display = 'none'; // Hide nav in chat
        
        renderMessages();
    }

    function closeChatWindow() {
        document.getElementById('chat-window-view').classList.remove('active');
        document.getElementById('main-nav').style.display = 'flex';
        currentChatPartnerId = null;
        loadChatList(); // Refresh list view to show last message
    }

    function renderMessages() {
        const msgArea = document.getElementById('chat-messages-area');
        msgArea.innerHTML = '';

        // Find the match object corresponding to this pair
        const match = matchesDb.find(m => 
            (m.info.from === currentUser.id && m.info.to === currentChatPartnerId) || 
            (m.info.from === currentChatPartnerId && m.info.to === currentUser.id)
        );

        if(match && match.chats) {
            match.chats.forEach(chat => {
                const isMine = chat.senderId === currentUser.id;
                const bubbleClass = isMine ? 'msg-sent' : 'msg-received';
                msgArea.innerHTML += `<div class="message-bubble ${bubbleClass}">${chat.text}</div>`;
            });
        }
        msgArea.scrollTop = msgArea.scrollHeight; // Auto scroll to bottom
    }

    function sendMessage(imgContent = null) {
        const input = document.getElementById('message-input');
        const text = imgContent || input.value.trim();
        if(!text && !imgContent) return;

        // Find match object
        const matchIdx = matchesDb.findIndex(m => 
            (m.info.from === currentUser.id && m.info.to === currentChatPartnerId) || 
            (m.info.from === currentChatPartnerId && m.info.to === currentUser.id)
        );

        if(matchIdx !== -1) {
            matchesDb[matchIdx].chats.push({
                senderId: currentUser.id,
                text: text,
                timestamp: Date.now()
            });
            saveToStorage();
            renderMessages();
            if(!imgContent) input.value = ''; // Clear input if text
            // Simulate reply if partner is fake and in dev mode
            simulateFakeReply(currentChatPartnerId);
        }
    }

    function handleChatImageSelect(event) {
         const file = event.target.files[0];
         if (file) {
             // In a real app, upload to server and get URL. Here we use blob.
             const blobUrl = URL.createObjectURL(file);
             const imgHtml = `<img src="${blobUrl}" class="chat-image-preview" alt="sent image">`;
             sendMessage(imgHtml);
         }
    }

    function simulateFakeReply(partnerId) {
        if(!devModeActive) return;
        const partner = usersDb.find(u => u.id === partnerId);
        if(partner && partner.isFake) {
             setTimeout(() => {
                  // Find match object again to push reply
                const matchIdx = matchesDb.findIndex(m => (m.info.from === currentUser.id && m.info.to === partnerId) || (m.info.from === partnerId && m.info.to === currentUser.id));
                if(matchIdx !== -1) {
                    const replies = ["Hey!", "How are you?", "Nice pic!", "Haha yeah.", "I'm from " + partner.location + " too."];
                    const randomReply = replies[Math.floor(Math.random() * replies.length)];
                     matchesDb[matchIdx].chats.push({
                        senderId: partnerId, // Fake user sends it
                        text: randomReply,
                        timestamp: Date.now()
                    });
                    saveToStorage();
                    if(currentChatPartnerId === partnerId) renderMessages();
                }
             }, 2000);
        }
    }


    // --- PROFILE VIEW & DEVELOPER MODE ---
    function loadMyProfileData() {
        document.getElementById('my-profile-name').innerText = currentUser.name;
        document.getElementById('my-profile-loc').innerText = currentUser.location;
        document.getElementById('my-profile-pic').src = currentUser.pic;
        updateDevUserSelect();
    }

    function toggleDevMode() {
        devModeActive = !devModeActive;
        document.getElementById('dev-panel-area').classList.toggle('active', devModeActive);
        alert("Developer Mode: " + (devModeActive ? "ON" : "OFF"));
    }

    function generateFakeUsers(count) {
        const loc = currentUser.location || 'Delhi';
        const names = ['Aanya', 'Vihaan', 'Myra', 'Arjun', 'Sara', 'Kabir'];
        const genders = ['women', 'men', 'women', 'men', 'women', 'men'];

        for(let i=0; i<count; i++) {
            const rand = Math.floor(Math.random() * names.length);
            const fakeUser = {
                id: 'fake_' + Date.now() + '_' + i,
                name: names[rand] + ' (Fake)',
                location: loc,
                pic: `https://randomuser.me/api/portraits/${genders[rand]}/${Math.floor(Math.random()*90)}.jpg`,
                isProfileComplete: true,
                isFake: true
            };
            usersDb.push(fakeUser);
        }
        saveToStorage();
        alert(`${count} fake users generated in ${loc}. Go to Discover tab to see them.`);
        updateDevUserSelect();
    }

    function updateDevUserSelect() {
        const select = document.getElementById('dev-user-select');
        select.innerHTML = '<option value="">Select a user to impersonate...</option>';
        // Add real user option to switch back
        select.innerHTML += `<option value="${realUserId}">My Real Profile (${usersDb.find(u=>u.id===realUserId)?.name})</option>`;
        
        usersDb.filter(u => u.isFake).forEach(u => {
             select.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });
    }

    function devSwitchUser() {
        const selectedId = document.getElementById('dev-user-select').value;
        if(!selectedId) return;
        
        currentUser = usersDb.find(u => u.id === selectedId);
        alert(`Switched context to: ${currentUser.name}. You can now use the app as them.`);
        loadMyProfileData();
        // Don't saveToStorage here, as this is temporary dev switching
    }

    function resetApp() {
        if(confirm("Are you sure? This will delete all users, matches, and chats.")) {
            localStorage.removeItem('mm_users');
            localStorage.removeItem('mm_matches');
            localStorage.removeItem('mm_currentUser');
            location.reload();
        }
    }

    // --- STORAGE HELPERS ---
    function saveToStorage() {
        localStorage.setItem('mm_users', JSON.stringify(usersDb));
        localStorage.setItem('mm_matches', JSON.stringify(matchesDb));
        if(currentUser) localStorage.setItem('mm_currentUser', JSON.stringify(currentUser));
    }

    function loadFromStorage() {
        const u = localStorage.getItem('mm_users');
        const m = localStorage.getItem('mm_matches');
        const cu = localStorage.getItem('mm_currentUser');
        if(u) usersDb = JSON.parse(u);
        if(m) matchesDb = JSON.parse(m);
        if(cu) currentUser = JSON.parse(cu);
    }

</script>
</body>
</html>